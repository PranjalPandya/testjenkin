{ 
  "variables": {
    "region": "us-east-1",
    "vpc_id": "vpc-05580c66c3f837690",
    "subnet_id": "subnet-0f8c6a12775ebd092",
    "security_group_id": "sg-07151bd734bc4b906",
    "associate_public_ip_address": "false",
    "instance_type": "t2.micro",
    "search_filter_regex": "amzn2-ami-hvm-2.0.????????-x86_64-gp2",
    "root-device-type": "ebs",
    "virtualization-type": "hvm",
    "account_origin": "default origin",
    "owners": "099720109477",
    "name_tag": "Pipeline-Hardened-test",
    "ssh_username": "ec2-user",
    "creation_date": "{{isotime \"2006.01.02.1505\"}}",
    "build_version": "{{isotime \"150405\"}}",
    "os_version": "Amazon Linux2"
  },
  "builders": [
    {
      "type": "amazon-ebs",
      "profile": "{{user `aws_profile`}}",
      "region": "{{user `region`}}",
      "vpc_id": "{{user `vpc_id`}}",
      "subnet_id": "{{user `subnet_id`}}",
      "associate_public_ip_address": "{{user `associate_public_ip_address`}}",
      "security_group_id": "{{user `security_group_id`}}",
      "source_ami_filter": {
        "filters": {
          "virtualization-type": "hvm",
          "name": "{{user `search_filter_regex`}}",
          "root-device-type": "ebs"
        },
        "owners": ["amazon","self"],
        "most_recent": true
      },
      "instance_type": "{{user `instance_type`}}",
      "ami_name": "{{user `name_tag`}}-{{user `creation_date`}}",
      "ssh_username": "{{user `ssh_username`}}",
      "tags": {
        "Name": "{{user `name_tag`}}-{{user `creation_date`}}",
        "OS_Version": "{{user `os_version`}}",
        "Build_Version": "Build Version-{{user `build_version`}}",
        "Base_AMI_Name": "{{ .SourceAMIName }}",
        "account_origin": "{{user `account_origin`}}"
      }
    }
  ],
  "provisioners": [
    {
    "type": "file",
    "source": "demofreetier.pub",
    "destination": "/tmp/authorized_keys"
    },
    {
      "type": "shell",
      "inline": [
        "sleep 30",
        "cd /home/ec2-user/.ssh",
        "sudo mkdir .ssh",
        "sudo chmod 700 .ssh",
        "sudo chown ec2-user: .ssh",
        "sudo cat /tmp/authorized_keys >> /home/ec2-user/.ssh/authorized_keys"
        ]
    }
  ]
}
